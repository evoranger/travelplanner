<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Planner</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: { bg: '#FAF9F6', card: '#FFFFFF', text: '#404040', sub: '#808080', accent: '#7F171F', border: '#E5E5E5', kraft: '#E0DCD3' }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FAF9F6; color: #404040; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Sidebar active state */
        .nav-item.active { background-color: #FAF9F6; color: #7F171F; border-right: 4px solid #7F171F; font-weight: bold; }
        .nav-item.active i { color: #7F171F; }
        
        .modal-enter { animation: modalFadeIn 0.2s ease-out forwards; }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #sync-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 50; background: rgba(0,0,0,0.7); color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary i.fa-chevron-down { transform: rotate(180deg); }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-5px)} 100% {opacity: 1; transform: translateY(0)} }

        .calendar-cell { min-height: 80px; }
        .calendar-event { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Sidebar Transitions */
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans overflow-hidden">

    <div id="sync-status"><i class="fas fa-sync fa-spin mr-1"></i>同步中...</div>

    <!-- Sidebar & Overlay -->
    <div id="sidebar-overlay" onclick="window.app.toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden opacity-0"></div>
    <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-2xl z-50 transform -translate-x-full flex flex-col">
        <div class="p-5 border-b border-muji-border flex justify-between items-center bg-muji-bg">
            <h2 class="font-bold text-muji-accent tracking-widest">MENU</h2>
            <button onclick="window.app.toggleSidebar()" class="text-muji-sub hover:text-muji-text p-2"><i class="fas fa-times text-lg"></i></button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="window.app.switchTab('plan')" class="nav-item w-full text-left px-4 py-3 rounded text-muji-text hover:bg-muji-bg transition flex items-center active">
                <i class="fas fa-calendar-alt w-6 text-center mr-3 text-muji-sub"></i> PLAN <span class="text-xs text-muji-sub ml-auto">總覽</span>
            </button>
            <button onclick="window.app.switchTab('guide')" class="nav-item w-full text-left px-4 py-3 rounded text-muji-text hover:bg-muji-bg transition flex items-center">
                <i class="fas fa-map-signs w-6 text-center mr-3 text-muji-sub"></i> GUIDE <span class="text-xs text-muji-sub ml-auto">行程導覽</span>
            </button>
            <button onclick="window.app.switchTab('rate')" class="nav-item w-full text-left px-4 py-3 rounded text-muji-text hover:bg-muji-bg transition flex items-center">
                <i class="fas fa-calculator w-6 text-center mr-3 text-muji-sub"></i> RATE <span class="text-xs text-muji-sub ml-auto">匯率</span>
            </button>
            <button onclick="window.app.switchTab('lists')" class="nav-item w-full text-left px-4 py-3 rounded text-muji-text hover:bg-muji-bg transition flex items-center">
                <i class="fas fa-list-ul w-6 text-center mr-3 text-muji-sub"></i> LISTS <span class="text-xs text-muji-sub ml-auto">清單</span>
            </button>
        </nav>
        <div class="p-4 border-t border-muji-border text-xs text-center text-muji-sub">
            &copy; 2026 廣島四國之旅
        </div>
    </div>

    <!-- Header -->
    <header class="flex-none bg-muji-bg px-4 py-4 border-b border-muji-border z-10 shadow-sm flex items-center gap-3">
        <button onclick="window.app.toggleSidebar()" class="text-muji-text text-lg p-2 rounded hover:bg-gray-200 transition">
            <i class="fas fa-bars"></i>
        </button>
        <div class="flex-1 flex justify-between items-center overflow-hidden">
            <div class="flex items-center gap-2 overflow-hidden">
                <h1 id="app-title-display" class="text-lg font-bold tracking-widest text-muji-accent truncate">廣島四國No Bullshit團</h1>
                <button onclick="window.app.openSimpleInput('編輯標題', 'title', document.getElementById('app-title-display').innerText)" class="text-gray-300 hover:text-muji-sub text-xs flex-none"><i class="fas fa-pen"></i></button>
            </div>
            <div class="text-right flex-none pl-2">
                <p class="text-xs font-bold text-muji-text" id="current-date">--/--</p>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-4 relative bg-muji-bg">

        <!-- ================= PLAN TAB (Overview) ================= -->
        <div id="tab-plan" class="tab-content active">
            <div class="space-y-6">
                <!-- Flight Info -->
                <div class="bg-muji-card p-5 rounded-lg shadow-sm border border-muji-border">
                    <div class="flex justify-between items-center mb-3 border-b border-muji-border pb-2">
                        <h3 class="text-sm font-bold text-muji-sub uppercase tracking-wide"><i class="fas fa-plane-departure mr-2"></i>航班資訊</h3>
                        <button onclick="window.app.openFlightEditor()" class="text-xs text-gray-400 hover:text-muji-accent"><i class="fas fa-pen mr-1"></i>編輯</button>
                    </div>
                    <div id="flight-info-container">
                        <div class="text-center text-gray-400 py-4 text-xs"><i class="fas fa-spinner fa-spin mr-1"></i>載入中...</div>
                    </div>
                </div>

                <!-- Accommodation -->
                <div class="bg-muji-card p-5 rounded-lg shadow-sm border border-muji-border">
                    <div class="flex justify-between items-center mb-3 border-b border-muji-border pb-2">
                        <h3 class="text-sm font-bold text-muji-sub uppercase tracking-wide"><i class="fas fa-bed mr-2"></i>住宿</h3>
                        <button onclick="window.app.openHotelEditor()" class="text-xs bg-muji-bg px-2 py-1 rounded border border-muji-border hover:bg-gray-100 transition"><i class="fas fa-plus mr-1"></i>新增</button>
                    </div>
                    <div id="hotel-container" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- ================= GUIDE TAB (Detailed & Itinerary) ================= -->
        <div id="tab-guide" class="tab-content">
            <div class="space-y-6">
                
                <!-- 1. Flight Info (Detailed) -->
                <details class="group bg-muji-card rounded-lg shadow-sm border border-muji-border overflow-hidden" open>
                    <summary class="px-4 py-3 bg-muji-bg border-b border-muji-border flex justify-between items-center font-bold text-muji-text">
                        <span><i class="fas fa-plane mr-2 text-muji-accent"></i>航班資訊 (詳細)</span>
                        <div class="flex items-center gap-3">
                            <button onclick="window.app.openFlightEditor(); event.preventDefault();" class="text-xs text-gray-400 hover:text-muji-accent z-10"><i class="fas fa-pen mr-1"></i>編輯</button>
                            <i class="fas fa-chevron-down text-muji-sub text-xs transition-transform duration-300"></i>
                        </div>
                    </summary>
                    <div class="p-4 text-sm text-muji-text space-y-6" id="flight-guide-container">
                        <!-- Dynamic content -->
                    </div>
                </details>

                <!-- 2. Hotel Info (Detailed) -->
                <details class="group bg-muji-card rounded-lg shadow-sm border border-muji-border overflow-hidden">
                    <summary class="px-4 py-3 bg-muji-bg border-b border-muji-border flex justify-between items-center font-bold text-muji-text">
                        <span><i class="fas fa-hotel mr-2 text-muji-accent"></i>酒店資訊 (詳細)</span>
                        <div class="flex items-center gap-3">
                             <button onclick="window.app.openHotelEditor(); event.preventDefault();" class="text-xs text-gray-400 hover:text-muji-accent z-10"><i class="fas fa-plus mr-1"></i>新增</button>
                            <i class="fas fa-chevron-down text-muji-sub text-xs transition-transform duration-300"></i>
                        </div>
                    </summary>
                    <div class="p-4 text-sm text-muji-text space-y-6" id="hotel-guide-container">
                        <!-- Dynamic content -->
                    </div>
                </details>

                <!-- 3. Timeline / Calendar (Moved from PLAN) -->
                <div>
                    <h3 class="text-sm font-bold text-muji-sub mb-4 uppercase tracking-wide px-1 flex justify-between items-center">
                        <span><i class="fas fa-map-signs mr-2"></i>行程</span>
                        <div class="bg-gray-200 rounded-lg p-1 flex">
                            <button onclick="window.app.togglePlanView('timeline')" id="btn-view-timeline" class="px-3 py-1 rounded-md text-xs font-bold bg-white text-muji-accent shadow-sm transition-all"><i class="fas fa-list-ul mr-1"></i>列表</button>
                            <button onclick="window.app.togglePlanView('calendar')" id="btn-view-calendar" class="px-3 py-1 rounded-md text-xs font-bold text-gray-500 transition-all"><i class="fas fa-calendar-alt mr-1"></i>日曆</button>
                        </div>
                    </h3>
                    
                    <div id="plan-view-timeline">
                        <div id="plan-timeline-container" class="space-y-6"></div>
                        <div class="mt-6">
                            <button onclick="window.app.openPlanEditor()" class="w-full text-left py-3 px-4 border-2 border-dashed border-muji-border rounded-lg text-muji-sub text-sm hover:bg-white hover:text-muji-accent transition"><i class="fas fa-plus mr-1"></i> 新增行程 (自選日期)</button>
                        </div>
                    </div>

                    <div id="plan-view-calendar" class="hidden">
                        <div class="bg-white rounded-lg shadow-sm border border-muji-border p-2">
                            <div class="flex justify-between items-center mb-4 px-2 pt-2">
                                <button onclick="window.app.changeMonth(-1)" class="text-muji-sub hover:text-muji-text"><i class="fas fa-chevron-left"></i></button>
                                <span id="calendar-month-year" class="font-bold text-muji-text">2026年 2月</span>
                                <button onclick="window.app.changeMonth(1)" class="text-muji-sub hover:text-muji-text"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs text-muji-sub mb-2"><div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div></div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-xs"></div>
                        </div>
                        <div class="mt-4 text-center">
                            <button onclick="window.app.openPlanEditor()" class="bg-muji-text text-white px-4 py-2 rounded-full text-sm shadow hover:bg-black"><i class="fas fa-plus mr-1"></i> 新增行程</button>
                        </div>
                    </div>
                </div>

                <!-- 4. Google Maps List Button -->
                <div class="bg-muji-card p-5 rounded-lg shadow-sm border border-muji-border text-center mt-4">
                    <div class="mb-3 text-muji-accent text-4xl"><i class="fas fa-map-marked-alt"></i></div>
                    <h3 class="text-lg font-bold text-muji-text mb-2">我的儲存清單</h3>
                    <p class="text-xs text-muji-sub mb-4">Google Maps Saved List</p>
                    <a href="https://www.google.com/maps/@34.1681087,132.4675093,9z/data=!4m6!1m2!10m1!1e1!11m2!2shRhaqwkRS8OxioWXvodvgA!3e3?entry=ttu&g_ep=EgoyMDI2MDEwNy4wIKXMDSoASAFQAw%3D%3D" target="_blank" class="block w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition"><i class="fas fa-external-link-alt mr-2"></i>打開 Google Maps 清單</a>
                    <p class="text-[10px] text-gray-400 mt-2">*點擊將開啟 Google Maps App</p>
                </div>
            </div>
        </div>

        <!-- ================= RATE TAB ================= -->
        <div id="tab-rate" class="tab-content">
            <div class="bg-muji-card p-6 rounded-lg shadow-sm border border-muji-border">
                <h3 class="text-sm font-bold text-muji-sub mb-4 uppercase tracking-wide"><i class="fas fa-calculator mr-2"></i>匯率換算器</h3>
                
                <!-- Rate Input with Refresh Button -->
                <div class="flex items-center justify-between mb-6 bg-gray-50 p-3 rounded">
                    <div class="flex items-center">
                        <span class="text-xs text-gray-500 mr-2">匯率 (1 JPY = ? HKD)</span>
                        <button onclick="window.app.refreshRate()" class="text-gray-400 hover:text-muji-accent transition-transform active:scale-90" title="更新匯率">
                            <i id="rate-refresh-icon" class="fas fa-sync-alt text-xs"></i>
                        </button>
                    </div>
                    <input type="number" id="calc-rate" value="0.052" step="0.0001" class="w-24 text-right bg-transparent font-bold text-muji-accent border-b border-gray-300 focus:outline-none" oninput="window.app.calcUpdate('rate')">
                </div>

                <div class="mb-4 relative">
                    <label class="block text-[10px] text-muji-sub mb-1">日幣 (JPY)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">¥</span>
                        <input type="number" id="calc-jpy" class="w-full bg-muji-bg p-4 pl-8 rounded-lg text-xl font-bold text-muji-text focus:outline-none border border-transparent focus:border-muji-accent transition" placeholder="0" oninput="window.app.calcUpdate('jpy')">
                    </div>
                </div>
                <div class="text-center -my-2 relative z-10"><span class="bg-white rounded-full p-1 border border-muji-border text-gray-400 text-xs"><i class="fas fa-exchange-alt rotate-90"></i></span></div>
                <div class="mt-4 relative">
                    <label class="block text-[10px] text-muji-sub mb-1">港幣 (HKD)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">$</span>
                        <input type="number" id="calc-hkd" class="w-full bg-muji-bg p-4 pl-8 rounded-lg text-xl font-bold text-muji-text focus:outline-none border border-transparent focus:border-muji-accent transition" placeholder="0" oninput="window.app.calcUpdate('hkd')">
                    </div>
                </div>
                <div class="mt-6 grid grid-cols-4 gap-2">
                    <button onclick="window.app.calcAdd(100)" class="bg-gray-100 py-2 rounded text-xs text-gray-600 hover:bg-gray-200 shadow-sm">+100</button>
                    <button onclick="window.app.calcAdd(500)" class="bg-gray-100 py-2 rounded text-xs text-gray-600 hover:bg-gray-200 shadow-sm">+500</button>
                    <button onclick="window.app.calcAdd(1000)" class="bg-gray-100 py-2 rounded text-xs text-gray-600 hover:bg-gray-200 shadow-sm">+1k</button>
                    <button onclick="window.app.calcClear()" class="bg-red-50 py-2 rounded text-xs text-red-400 hover:bg-red-100 shadow-sm">清除</button>
                </div>
            </div>
        </div>

        <!-- ================= LISTS TAB ================= -->
        <div id="tab-lists" class="tab-content">
            <div class="bg-muji-card rounded-lg shadow-sm overflow-hidden mb-6">
                <div class="bg-muji-kraft px-4 py-3"><h3 class="font-bold text-muji-text text-sm"><i class="fas fa-check-square mr-2"></i>行前準備</h3></div>
                <div id="checklist-container" class="p-2"></div>
                <div class="p-3"><button onclick="window.app.openSimpleInput('新增待辦事項', 'checklist')" class="w-full text-left py-3 px-4 border-2 border-dashed border-muji-border rounded-lg text-muji-sub text-sm hover:bg-white hover:text-muji-accent transition"><i class="fas fa-plus mr-1"></i> 新增項目</button></div>
            </div>
            <div class="bg-muji-card rounded-lg shadow-sm overflow-hidden">
                <div class="bg-muji-kraft px-4 py-3"><h3 class="font-bold text-muji-text text-sm"><i class="fas fa-sticky-note mr-2"></i>備忘錄</h3></div>
                <div id="memo-container" class="p-4 space-y-3"></div>
                <div class="p-3"><button onclick="window.app.openSimpleInput('新增備忘', 'memo')" class="w-full text-left py-3 px-4 border-2 border-dashed border-muji-border rounded-lg text-muji-sub text-sm hover:bg-white hover:text-muji-accent transition"><i class="fas fa-plus mr-1"></i> 新增備忘</button></div>
            </div>
        </div>

        <!-- ================= INFO TAB ================= -->
        <div id="tab-info" class="tab-content">
            <div class="space-y-4">
                <div class="col-span-2 bg-muji-card p-5 rounded-lg shadow-sm border border-muji-border">
                    <h3 class="text-sm font-bold text-muji-text mb-3">⚠️ 旅遊注意事項</h3>
                    <ul class="text-sm text-muji-sub list-disc pl-5 space-y-2"><li>日本電壓 100V 雙平腳</li><li>垃圾請分類帶回飯店</li></ul>
                </div>
            </div>
        </div>

    </main>

    <!-- Modals -->
    <div id="simple-input-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-lg modal-enter overflow-hidden">
            <div class="bg-muji-bg px-4 py-3 border-b border-muji-border flex justify-between items-center">
                <h3 id="simple-input-title" class="font-bold text-muji-text">輸入</h3>
                <button onclick="window.app.closeSimpleInput()" class="text-muji-sub hover:text-black"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4">
                <input type="text" id="simple-input-value" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none border border-transparent focus:border-muji-sub" placeholder="請輸入內容...">
                <input type="hidden" id="simple-input-type">
            </div>
            <div class="px-4 py-3 bg-muji-bg border-t border-muji-border flex justify-end">
                <button onclick="window.app.confirmSimpleInput()" class="bg-muji-text text-white px-4 py-2 rounded text-sm hover:bg-black transition">確定</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-lg shadow-lg modal-enter overflow-hidden text-center">
            <div class="p-5"><p id="alert-msg" class="text-sm text-muji-text"></p></div>
            <div class="px-4 py-3 bg-muji-bg border-t border-muji-border">
                <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="bg-muji-text text-white px-6 py-2 rounded text-sm hover:bg-black transition">好</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-lg shadow-lg modal-enter overflow-hidden text-center">
            <div class="p-5">
                <p id="confirm-msg" class="text-sm text-muji-text font-bold mb-2">確認</p>
                <p class="text-xs text-gray-500">確定要執行此動作嗎？無法復原。</p>
            </div>
            <div class="flex border-t border-muji-border">
                <button onclick="window.app.closeConfirm()" class="flex-1 py-3 text-xs text-gray-500 border-r border-muji-border hover:bg-gray-50">取消</button>
                <button onclick="window.app.doConfirm()" class="flex-1 py-3 text-xs text-red-500 font-bold hover:bg-gray-50">確定刪除</button>
            </div>
        </div>
    </div>

    <div id="flight-form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-lg modal-enter overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-muji-bg px-4 py-3 border-b border-muji-border flex justify-between items-center flex-none">
                <h3 class="font-bold text-muji-text">編輯航班資訊</h3>
                <button onclick="window.app.closeFlightModal()" class="text-muji-sub hover:text-black"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-4 overflow-y-auto flex-1">
                <div class="border-l-4 border-muji-accent pl-3">
                    <h4 class="text-xs font-bold text-muji-accent mb-2">去程 (Outbound)</h4>
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <div class="w-2/3"><label class="text-[10px] text-gray-400">日期</label><input type="text" id="fl-out-date" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                            <div class="w-1/3"><label class="text-[10px] text-gray-400">航班</label><input type="text" id="fl-out-no" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <div><label class="text-[10px] text-gray-400">出發地</label><input type="text" id="fl-out-dep" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200 font-bold"></div>
                            <div><label class="text-[10px] text-gray-400">時間</label><input type="text" id="fl-out-dep-t" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                            <i class="fas fa-arrow-right text-gray-300 text-xs mt-3"></i>
                            <div><label class="text-[10px] text-gray-400">目的地</label><input type="text" id="fl-out-arr" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200 font-bold"></div>
                            <div><label class="text-[10px] text-gray-400">時間</label><input type="text" id="fl-out-arr-t" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                        </div>
                    </div>
                </div>
                <div class="border-l-4 border-muji-sub pl-3">
                    <h4 class="text-xs font-bold text-muji-sub mb-2">回程 (Inbound)</h4>
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <div class="w-2/3"><label class="text-[10px] text-gray-400">日期</label><input type="text" id="fl-in-date" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                            <div class="w-1/3"><label class="text-[10px] text-gray-400">航班</label><input type="text" id="fl-in-no" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <div><label class="text-[10px] text-gray-400">出發地</label><input type="text" id="fl-in-dep" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200 font-bold"></div>
                            <div><label class="text-[10px] text-gray-400">時間</label><input type="text" id="fl-in-dep-t" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                            <i class="fas fa-arrow-right text-gray-300 text-xs mt-3"></i>
                            <div><label class="text-[10px] text-gray-400">目的地</label><input type="text" id="fl-in-arr" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200 font-bold"></div>
                            <div><label class="text-[10px] text-gray-400">時間</label><input type="text" id="fl-in-arr-t" class="w-full bg-muji-bg p-1.5 rounded text-xs border border-gray-200"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-4 py-3 bg-muji-bg border-t border-muji-border flex justify-end flex-none">
                <button onclick="window.app.saveFlightEditor()" class="bg-muji-text text-white px-4 py-2 rounded text-sm hover:bg-black transition">儲存變更</button>
            </div>
        </div>
    </div>

    <!-- Plan Modal -->
    <div id="plan-form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-lg modal-enter overflow-hidden">
            <div class="bg-muji-bg px-4 py-3 border-b border-muji-border flex justify-between items-center"><h3 class="font-bold text-muji-text" id="plan-modal-title">編輯行程</h3><button onclick="window.app.closePlanModal()" class="text-muji-sub hover:text-black"><i class="fas fa-times"></i></button></div>
            <div class="p-4 space-y-3">
                <input type="hidden" id="plan-id"><input type="hidden" id="plan-order">
                <div class="flex gap-2">
                    <div class="w-2/3"><label class="block text-xs text-muji-sub mb-1">日期 (用於日曆)</label><input type="date" id="plan-date" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                    <div class="w-1/3"><label class="block text-xs text-muji-sub mb-1">時間</label><input type="time" id="plan-time" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                </div>
                <div><label class="block text-xs text-muji-sub mb-1">標題</label><input type="text" id="plan-title" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                <div><label class="block text-xs text-muji-sub mb-1">重點提示</label><input type="text" id="plan-highlight" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                <div><label class="block text-xs text-muji-sub mb-1">詳細內容</label><textarea id="plan-content" rows="4" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></textarea></div>
                <div><label class="block text-xs text-muji-sub mb-1">地圖關鍵字</label><input type="text" id="plan-map" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
            </div>
            <div class="px-4 py-3 bg-muji-bg border-t border-muji-border flex justify-between">
                <button onclick="window.app.deletePlanItem()" id="btn-delete-plan" class="text-red-400 text-sm hidden"><i class="fas fa-trash-alt mr-1"></i> 刪除</button>
                <button onclick="window.app.savePlanEditor()" class="bg-muji-text text-white px-4 py-2 rounded text-sm hover:bg-black transition ml-auto">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- Hotel Modal -->
    <div id="hotel-form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-lg modal-enter overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-muji-bg px-4 py-3 border-b border-muji-border flex justify-between items-center flex-none">
                <h3 class="font-bold text-muji-text" id="hotel-modal-title">編輯住宿</h3><button onclick="window.app.closeHotelModal()" class="text-muji-sub hover:text-black"><i class="fas fa-times"></i></button></div>
            <div class="p-4 space-y-3 overflow-y-auto flex-1">
                <input type="hidden" id="hotel-id">
                <div><label class="block text-xs text-muji-sub mb-1">飯店名稱</label><input type="text" id="hotel-name" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                <div><label class="block text-xs text-muji-sub mb-1">地點</label><input type="text" id="hotel-location" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                <div class="flex gap-2">
                    <div class="w-1/2"><label class="block text-xs text-muji-sub mb-1">入住日期</label><input type="date" id="hotel-date-start" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                    <div class="w-1/2"><label class="block text-xs text-muji-sub mb-1">退房日期</label><input type="date" id="hotel-date-end" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="hotel-checkin" placeholder="IN 15:00 (時間)" class="w-1/2 bg-muji-bg p-2 rounded text-sm">
                    <input type="text" id="hotel-checkout" placeholder="OUT 10:00 (時間)" class="w-1/2 bg-muji-bg p-2 rounded text-sm">
                </div>
                <div><label class="block text-xs text-muji-sub mb-1">電話</label><input type="text" id="hotel-phone" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none"></div>
                <div><label class="block text-xs text-muji-sub mb-1">備註 / 取消政策</label><textarea id="hotel-notes" rows="4" class="w-full bg-muji-bg p-2 rounded text-sm focus:outline-none border border-transparent focus:border-muji-sub" placeholder="貼上取消政策或其他資訊..."></textarea></div>
            </div>
            <div class="px-4 py-3 bg-muji-bg border-t border-muji-border flex justify-between flex-none">
                <button onclick="window.app.deleteHotelItem()" id="btn-delete-hotel" class="text-red-400 text-sm hidden"><i class="fas fa-trash-alt mr-1"></i> 刪除</button>
                <button onclick="window.app.saveHotelEditor()" class="bg-muji-text text-white px-4 py-2 rounded text-sm hover:bg-black transition ml-auto">儲存</button>
            </div>
        </div>
    </div>

    <!-- Script Module -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyD6oDnZsAmLkBkyfPpu5QETJP52RtnyWoI",
            authDomain: "travel-planner-2675d.firebaseapp.com",
            projectId: "travel-planner-2675d",
            storageBucket: "travel-planner-2675d.firebasestorage.app",
            messagingSenderId: "44348673268",
            appId: "1:44348673268:web:f1882fe26030c9eb38e2a1"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        window.app = window.app || {};
        let db;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init error:", e);
            window.app.showAlert("Firebase 初始化失敗");
        }

        function showSync() {
            const el = document.getElementById('sync-status');
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 2000);
        }

        const appState = {
            plans: [],
            calendarDate: new Date('2026-02-28'),
            planView: 'timeline',
            flights: {
                outbound: { date: '2026/02/28 (六)', flight: 'UO822', dep: 'HKG', depTime: '09:30', arr: 'HIR', arrTime: '13:45' },
                inbound: { date: '2026/03/08 (日)', flight: 'UO643', dep: 'TAK', depTime: '14:30', arr: 'HKG', arrTime: '18:00' }
            }
        };

        window.app.showAlert = (msg) => {
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('alert-modal').classList.remove('hidden');
        }

        let confirmCallback = null;
        window.app.openConfirm = (msg, cb) => {
            document.getElementById('confirm-msg').innerText = msg;
            confirmCallback = cb;
            document.getElementById('confirm-modal').classList.remove('hidden');
        };
        window.app.closeConfirm = () => {
            document.getElementById('confirm-modal').classList.add('hidden');
            confirmCallback = null;
        };
        window.app.doConfirm = () => {
            if (confirmCallback) confirmCallback();
            window.app.closeConfirm();
        };

        window.app.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden', 'opacity-0');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        };

        window.app.calcUpdate = (source) => {
            const rate = parseFloat(document.getElementById('calc-rate').value) || 0;
            const jpyEl = document.getElementById('calc-jpy');
            const hkdEl = document.getElementById('calc-hkd');

            if (source === 'rate') {
                if (jpyEl.value) window.app.calcUpdate('jpy');
                else if (hkdEl.value) window.app.calcUpdate('hkd');
            } else if (source === 'jpy') {
                const jpy = parseFloat(jpyEl.value);
                if (!isNaN(jpy)) hkdEl.value = (jpy * rate).toFixed(2);
                else hkdEl.value = '';
            } else if (source === 'hkd') {
                const hkd = parseFloat(hkdEl.value);
                if (!isNaN(hkd)) jpyEl.value = (hkd / rate).toFixed(0);
                else jpyEl.value = '';
            }
        };

        window.app.calcAdd = (amount) => {
            const jpyEl = document.getElementById('calc-jpy');
            const current = parseFloat(jpyEl.value) || 0;
            jpyEl.value = current + amount;
            window.app.calcUpdate('jpy');
        };

        window.app.calcClear = () => {
            document.getElementById('calc-jpy').value = '';
            document.getElementById('calc-hkd').value = '';
        };
        
        window.app.refreshRate = async () => {
            const icon = document.getElementById('rate-refresh-icon');
            if(icon) icon.classList.add('fa-spin');
            
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                const hkdRate = data.rates.HKD;
                
                if(hkdRate) {
                    document.getElementById('calc-rate').value = hkdRate;
                    window.app.calcUpdate('rate');
                    window.app.showAlert(`匯率已更新：1 JPY ≈ ${hkdRate} HKD`);
                }
            } catch(e) {
                window.app.showAlert("匯率更新失敗，請檢查網路連線。");
            } finally {
                if(icon) icon.classList.remove('fa-spin');
            }
        };

        window.app.openSimpleInput = (title, type, currentValue = '') => {
            if (!db) return window.app.showAlert("資料庫尚未連線");
            document.getElementById('simple-input-title').innerText = title;
            document.getElementById('simple-input-value').value = currentValue;
            document.getElementById('simple-input-type').value = type;
            document.getElementById('simple-input-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('simple-input-value').focus(), 100);
        };

        window.app.closeSimpleInput = () => {
            document.getElementById('simple-input-modal').classList.add('hidden');
        };

        window.app.confirmSimpleInput = async () => {
            const text = document.getElementById('simple-input-value').value;
            const type = document.getElementById('simple-input-type').value;
            if (type === 'link') {
                const parts = text.split('|');
                const name = parts[0].trim();
                const url = parts.length > 1 ? parts[1].trim() : text.trim();
                if (!name || !url) return;
                 try {
                    await addDoc(collection(db, "links"), { name, url, created: Date.now() });
                    window.app.closeSimpleInput();
                } catch(e) { window.app.showAlert("新增連結失敗: " + e.message); }
                return;
            }

            if (!text) { window.app.closeSimpleInput(); return; }

            try {
                if (type === 'checklist') {
                    await addDoc(collection(db, "checklist"), { text, checked: false, created: Date.now() });
                } else if (type === 'memo') {
                    await addDoc(collection(db, "memos"), { text, created: Date.now() });
                } else if (type === 'title') {
                    await setDoc(doc(db, "settings", "general"), { title: text }, { merge: true });
                }
                window.app.closeSimpleInput();
            } catch(e) { 
                window.app.closeSimpleInput();
                window.app.showAlert("儲存失敗: " + e.message); 
            }
        };

        window.app.toggleCheck = async (id, checked) => {
            if(db) await updateDoc(doc(db, "checklist", id), { checked });
        };

        window.app.deleteCheck = async (id) => {
            if(db) await deleteDoc(doc(db, "checklist", id));
        };

        window.app.deleteMemo = (id) => {
            window.app.openConfirm("確定刪除此備忘？", async () => {
                if(db) await deleteDoc(doc(db, "memos", id));
            });
        };
        
        window.app.deleteLink = (id) => {
            window.app.openConfirm("確定刪除此連結？", async () => {
                if(db) await deleteDoc(doc(db, "links", id));
            });
        };

        function initLists() {
            if (!db) return;
            onSnapshot(query(collection(db, "checklist"), orderBy("created", "asc")), (snap) => {
                showSync();
                const container = document.getElementById('checklist-container');
                container.innerHTML = '';
                snap.forEach((docSnap) => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-2 border-b border-gray-100 last:border-0';
                    div.innerHTML = `
                        <input type="checkbox" ${item.checked ? 'checked' : ''} class="mr-3 h-5 w-5 accent-muji-accent" onchange="window.app.toggleCheck('${item.id}', ${!item.checked})">
                        <label class="flex-1 text-sm ${item.checked ? 'line-through text-gray-300' : 'text-muji-text'}">${item.text}</label>
                        <button onclick="window.app.deleteCheck('${item.id}')" class="text-gray-200 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    `;
                    container.appendChild(div);
                });
            });
            onSnapshot(query(collection(db, "memos"), orderBy("created", "asc")), (snap) => {
                showSync();
                const container = document.getElementById('memo-container');
                container.innerHTML = '';
                snap.forEach((docSnap) => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    const div = document.createElement('div');
                    div.className = 'bg-yellow-50 p-3 rounded shadow-sm border border-yellow-100 relative group';
                    const processedText = (item.text || "").replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-500 underline break-all"><i class="fas fa-link text-xs mr-1"></i>連結</a>');
                    div.innerHTML = `<p class="text-sm text-gray-700 whitespace-pre-wrap pr-6">${processedText}</p><button onclick="window.app.deleteMemo('${item.id}')" class="absolute top-2 right-2 text-yellow-300 hover:text-yellow-600"><i class="fas fa-times"></i></button>`;
                    container.appendChild(div);
                });
            });
            // Links
            onSnapshot(query(collection(db, "links"), orderBy("created", "asc")), (snap) => {
                showSync();
                const container = document.getElementById('quick-links-container');
                if(!container) return;
                container.innerHTML = '';
                snap.forEach((docSnap) => {
                    const item = { id: docSnap.id, ...docSnap.data() };
                    const div = document.createElement('div');
                    div.className = 'px-4 py-3 flex justify-between items-center group hover:bg-gray-50 transition';
                    div.innerHTML = `
                        <a href="${item.url}" target="_blank" class="flex-1 flex items-center text-sm text-muji-text">
                            <span class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 mr-3 text-xs flex-none"><i class="fas fa-link"></i></span>
                            <span class="font-bold truncate">${item.name}</span>
                        </a>
                        <button onclick="window.app.deleteLink('${item.id}')" class="text-gray-300 hover:text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        function initSettings() {
            if(!db) return;
            onSnapshot(doc(db, "settings", "general"), (doc) => {
                if (doc.exists() && doc.data().title) {
                    document.getElementById('app-title-display').innerText = doc.data().title;
                }
            });
            onSnapshot(doc(db, "settings", "flights"), (doc) => {
                if (doc.exists()) appState.flights = doc.data();
                renderFlightInfo();
            });
        }

        function renderFlightInfo() {
            const f = appState.flights;
            // Render to PLAN tab (brief)
            const planContainer = document.getElementById('flight-info-container');
            if(planContainer && f && f.outbound) {
                planContainer.innerHTML = `
                <div class="text-xs text-center text-muji-text font-bold mb-1 bg-gray-100 rounded py-1 mx-4">${f.outbound.date}</div>
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center"><span class="block text-2xl font-bold text-muji-accent">${f.outbound.dep}</span><span class="text-xs text-muji-sub">${f.outbound.depTime}</span></div>
                    <div class="flex-1 px-4 text-center">
                        <p class="text-xs font-bold mb-2">${f.outbound.flight}</p>
                        <div class="h-[1px] bg-muji-text w-full relative"><i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-muji-card px-1 text-xs"></i></div>
                        <p class="text-xs text-muji-sub mt-1">去程</p>
                    </div>
                    <div class="text-center"><span class="block text-2xl font-bold text-muji-accent">${f.outbound.arr}</span><span class="text-xs text-muji-sub">${f.outbound.arrTime}</span></div>
                </div>
                <div class="text-xs text-center text-muji-text font-bold mb-1 bg-gray-100 rounded py-1 mx-4 mt-2">${f.inbound.date}</div>
                <div class="flex justify-between items-center">
                    <div class="text-center"><span class="block text-2xl font-bold text-muji-accent">${f.inbound.dep}</span><span class="text-xs text-muji-sub">${f.inbound.depTime}</span></div>
                    <div class="flex-1 px-4 text-center">
                        <p class="text-xs font-bold mb-2">${f.inbound.flight}</p>
                        <div class="h-[1px] bg-muji-text w-full relative"><i class="fas fa-plane absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-muji-card px-1 text-xs"></i></div>
                        <p class="text-xs text-muji-sub mt-1">回程</p>
                    </div>
                    <div class="text-center"><span class="block text-2xl font-bold text-muji-accent">${f.inbound.arr}</span><span class="text-xs text-muji-sub">${f.inbound.arrTime}</span></div>
                </div>`;
            }

            // Render to GUIDE tab (detailed - reusable same structure for now, but in GUIDE context)
            const guideContainer = document.getElementById('flight-guide-container');
            if(guideContainer && f && f.outbound) {
                // GUIDE has headers in HTML already, just injecting content
                guideContainer.innerHTML = `
                <div class="relative pl-4 border-l-4 border-muji-accent">
                    <h4 class="font-bold text-lg mb-2">去程 (${f.outbound.dep} → ${f.outbound.arr})</h4>
                    <div class="grid grid-cols-[70px_1fr] gap-y-1 gap-x-2 text-sm">
                        <span class="text-muji-sub">日期：</span><span class="font-bold">${f.outbound.date}</span>
                        <span class="text-muji-sub">航班：</span><span>${f.outbound.flight}</span>
                        <span class="text-muji-sub">時間：</span><span class="font-bold">${f.outbound.depTime} 起飛 → ${f.outbound.arrTime} 抵達</span>
                    </div>
                </div>
                <div class="relative pl-4 border-l-4 border-muji-sub mt-6">
                    <h4 class="font-bold text-lg mb-2">回程 (${f.inbound.dep} → ${f.inbound.arr})</h4>
                    <div class="grid grid-cols-[70px_1fr] gap-y-1 gap-x-2 text-sm">
                        <span class="text-muji-sub">日期：</span><span class="font-bold">${f.inbound.date}</span>
                        <span class="text-muji-sub">航班：</span><span>${f.inbound.flight}</span>
                        <span class="text-muji-sub">時間：</span><span class="font-bold">${f.inbound.depTime} 起飛 → ${f.inbound.arrTime} 抵達</span>
                    </div>
                </div>`;
            }
        }

        window.app.openFlightEditor = () => {
            const f = appState.flights;
            document.getElementById('fl-out-date').value = f.outbound.date;
            document.getElementById('fl-out-no').value = f.outbound.flight;
            document.getElementById('fl-out-dep').value = f.outbound.dep;
            document.getElementById('fl-out-dep-t').value = f.outbound.depTime;
            document.getElementById('fl-out-arr').value = f.outbound.arr;
            document.getElementById('fl-out-arr-t').value = f.outbound.arrTime;

            document.getElementById('fl-in-date').value = f.inbound.date;
            document.getElementById('fl-in-no').value = f.inbound.flight;
            document.getElementById('fl-in-dep').value = f.inbound.dep;
            document.getElementById('fl-in-dep-t').value = f.inbound.depTime;
            document.getElementById('fl-in-arr').value = f.inbound.arr;
            document.getElementById('fl-in-arr-t').value = f.inbound.arrTime;

            document.getElementById('flight-form-modal').classList.remove('hidden');
        };

        window.app.closeFlightModal = () => document.getElementById('flight-form-modal').classList.add('hidden');

        window.app.saveFlightEditor = async () => {
            const newData = {
                outbound: {
                    date: document.getElementById('fl-out-date').value,
                    flight: document.getElementById('fl-out-no').value,
                    dep: document.getElementById('fl-out-dep').value,
                    depTime: document.getElementById('fl-out-dep-t').value,
                    arr: document.getElementById('fl-out-arr').value,
                    arrTime: document.getElementById('fl-out-arr-t').value
                },
                inbound: {
                    date: document.getElementById('fl-in-date').value,
                    flight: document.getElementById('fl-in-no').value,
                    dep: document.getElementById('fl-in-dep').value,
                    depTime: document.getElementById('fl-in-dep-t').value,
                    arr: document.getElementById('fl-in-arr').value,
                    arrTime: document.getElementById('fl-in-arr-t').value
                }
            };
            
            try {
                await setDoc(doc(db, "settings", "flights"), newData);
                window.app.closeFlightModal();
            } catch(e) { window.app.showAlert("儲存失敗: " + e.message); }
        };

        // --- 3. PLAN & HOTEL LOGIC ---
        
        window.app.togglePlanView = (mode) => {
            appState.planView = mode;
            const tBtn = document.getElementById('btn-view-timeline');
            const cBtn = document.getElementById('btn-view-calendar');
            const tView = document.getElementById('plan-view-timeline');
            const cView = document.getElementById('plan-view-calendar');

            if (mode === 'timeline') {
                tBtn.className = "px-3 py-1 rounded-md text-xs font-bold bg-white text-muji-accent shadow-sm transition-all";
                cBtn.className = "px-3 py-1 rounded-md text-xs font-bold text-gray-500 transition-all";
                tView.classList.remove('hidden'); cView.classList.add('hidden');
            } else {
                cBtn.className = "px-3 py-1 rounded-md text-xs font-bold bg-white text-muji-accent shadow-sm transition-all";
                tBtn.className = "px-3 py-1 rounded-md text-xs font-bold text-gray-500 transition-all";
                cView.classList.remove('hidden'); tView.classList.add('hidden');
                window.app.renderCalendar();
            }
        };

        // Updated openPlanEditor with defaultDate parameter
        window.app.openPlanEditor = (id = null, defaultDate = '') => {
            const modal = document.getElementById('plan-form-modal');
            const inputs = ['id','title','highlight','content','map','order','date','time'].map(k => document.getElementById('plan-'+k));
            const [idIn, titleIn, hlIn, ctIn, mapIn, ordIn, dateIn, timeIn] = inputs;
            const delBtn = document.getElementById('btn-delete-plan');
            const mTitle = document.getElementById('plan-modal-title');

            if (id) {
                const plan = appState.plans.find(p => p.id === id);
                if(plan) {
                    idIn.value = plan.id; titleIn.value = plan.title; hlIn.value = plan.highlight||''; 
                    ctIn.value = plan.content; mapIn.value = plan.mapQuery||''; ordIn.value = plan.order;
                    dateIn.value = plan.date||''; timeIn.value = plan.time||'';
                    delBtn.classList.remove('hidden'); mTitle.innerText = "編輯行程";
                }
            } else {
                inputs.forEach(i => i.value = '');
                ordIn.value = Date.now();
                if(defaultDate) dateIn.value = defaultDate; // Auto-fill date
                delBtn.classList.add('hidden'); mTitle.innerText = "新增行程";
            }
            modal.classList.remove('hidden');
        };

        window.app.closePlanModal = () => document.getElementById('plan-form-modal').classList.add('hidden');

        window.app.savePlanEditor = async () => {
            const id = document.getElementById('plan-id').value;
            const data = {
                title: document.getElementById('plan-title').value,
                highlight: document.getElementById('plan-highlight').value,
                content: document.getElementById('plan-content').value,
                mapQuery: document.getElementById('plan-map').value,
                order: parseInt(document.getElementById('plan-order').value) || Date.now(),
                date: document.getElementById('plan-date').value,
                time: document.getElementById('plan-time').value
            };
            if (!data.title) return window.app.showAlert("請輸入標題");
            try {
                if (id) await updateDoc(doc(db, "plans", id), data);
                else await addDoc(collection(db, "plans"), data);
                window.app.closePlanModal();
            } catch(e) { window.app.showAlert("儲存失敗: " + e.message); }
        };

        window.app.deletePlanItem = () => {
            const id = document.getElementById('plan-id').value;
            if(id) {
                window.app.closePlanModal(); 
                window.app.openConfirm("確定刪除此行程？", async () => {
                    await deleteDoc(doc(db, "plans", id)); 
                });
            }
        };

        window.app.movePlan = async (id, dir) => {
            const planToMove = appState.plans.find(p => p.id === id);
            if (!planToMove) return;
            const date = planToMove.date || 'unknown';
            const datePlans = appState.plans.filter(p => (p.date || 'unknown') === date);
            const currentIdx = datePlans.findIndex(p => p.id === id);
            if (currentIdx === -1) return;
            const targetIdx = currentIdx + dir;
            if (targetIdx < 0 || targetIdx >= datePlans.length) return;
            const targetPlan = datePlans[targetIdx];
            const tempOrder = planToMove.order;
            await updateDoc(doc(db, "plans", planToMove.id), { order: targetPlan.order });
            await updateDoc(doc(db, "plans", targetPlan.id), { order: tempOrder });
        };

        window.app.openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');

        window.app.changeMonth = (offset) => {
            appState.calendarDate.setMonth(appState.calendarDate.getMonth() + offset);
            window.app.renderCalendar();
        };

        window.app.renderCalendar = () => {
            const year = appState.calendarDate.getFullYear();
            const month = appState.calendarDate.getMonth();
            document.getElementById('calendar-month-year').innerText = `${year}年 ${month + 1}月`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            for (let i = 0; i < firstDay; i++) grid.appendChild(Object.assign(document.createElement('div'), {className: 'calendar-cell bg-gray-50 rounded'}));

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell bg-white border border-gray-100 rounded p-1 flex flex-col';
                cell.innerHTML = `<div class="text-center font-bold text-gray-400 mb-1">${day}</div>`;
                
                const events = appState.plans.filter(p => p.date === dateStr);
                events.sort((a,b) => (a.time||'').localeCompare(b.time||''));
                
                events.forEach(ev => {
                    const dot = document.createElement('div');
                    dot.className = 'flex items-center text-[10px] bg-muji-bg rounded px-1 mb-1 border-l-2 border-muji-accent cursor-pointer hover:bg-gray-100';
                    dot.onclick = () => window.app.openPlanEditor(ev.id);
                    const tm = ev.time ? `<span class="text-gray-500 mr-1">${ev.time}</span>` : '';
                    dot.innerHTML = `${tm}<span class="truncate font-bold text-muji-text">${ev.title}</span>`;
                    cell.appendChild(dot);
                });
                grid.appendChild(cell);
            }
        };

        window.app.openHotelEditor = (id = null) => {
            const modal = document.getElementById('hotel-form-modal');
            const inputs = ['id','name','location','checkin','checkout','phone','date-start','date-end','notes'].map(k => document.getElementById('hotel-'+k));
            const [idIn, nmIn, locIn, ciIn, coIn, phIn, dsIn, deIn, ntIn] = inputs;
            const delBtn = document.getElementById('btn-delete-hotel');
            const mTitle = document.getElementById('hotel-modal-title');

            if (id) {
                const h = window.app.hotelsCache.find(h => h.id === id);
                if(h) {
                    idIn.value = h.id; nmIn.value = h.name; locIn.value = h.location;
                    ciIn.value = h.checkin; coIn.value = h.checkout; phIn.value = h.phone||'';
                    dsIn.value = h.dateStart||''; deIn.value = h.dateEnd||'';
                    ntIn.value = h.notes||''; // Load notes
                    delBtn.classList.remove('hidden'); mTitle.innerText = "編輯住宿";
                }
            } else {
                inputs.forEach(i => i.value = '');
                delBtn.classList.add('hidden'); mTitle.innerText = "新增住宿";
            }
            modal.classList.remove('hidden');
        };
        
        window.app.closeHotelModal = () => document.getElementById('hotel-form-modal').classList.add('hidden');
        
        window.app.saveHotelEditor = async () => {
            const id = document.getElementById('hotel-id').value;
            const data = {
                name: document.getElementById('hotel-name').value,
                location: document.getElementById('hotel-location').value,
                checkin: document.getElementById('hotel-checkin').value,
                checkout: document.getElementById('hotel-checkout').value,
                phone: document.getElementById('hotel-phone').value,
                dateStart: document.getElementById('hotel-date-start').value,
                dateEnd: document.getElementById('hotel-date-end').value,
                notes: document.getElementById('hotel-notes').value, // Save notes
                created: Date.now()
            };
            if (!data.name) return window.app.showAlert("請輸入名稱");
            try {
                if (id) await updateDoc(doc(db, "hotels", id), data);
                else await addDoc(collection(db, "hotels"), data);
                window.app.closeHotelModal();
            } catch(e) { window.app.showAlert("儲存失敗: " + e.message); }
        };

        window.app.deleteHotelItem = () => {
            const id = document.getElementById('hotel-id').value;
            if(id) {
                window.app.closeHotelModal(); 
                window.app.openConfirm("確定刪除此住宿？", async () => {
                    await deleteDoc(doc(db, "hotels", id)); 
                });
            }
        };

        window.app.switchTab = (tabId) => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);

            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navButtons = document.querySelectorAll('.nav-item');
            for(let btn of navButtons) {
                if(btn.getAttribute('onclick').includes(`'${tabId}'`)) {
                    btn.classList.add('active');
                    break;
                }
            }
            document.querySelector('main').scrollTop = 0;
        };

        window.app.updateDate = () => {
            const now = new Date();
            document.getElementById('current-date').innerText = `${now.getMonth()+1}/${now.getDate()}`;
        };

        function initPlans() {
            if(!db) return;
            onSnapshot(query(collection(db, "plans"), orderBy("order", "asc")), (snap) => {
                showSync();
                appState.plans = [];
                const container = document.getElementById('plan-timeline-container');
                container.innerHTML = '';
                
                snap.forEach(d => {
                    const p = {id: d.id, ...d.data()};
                    appState.plans.push(p);
                });

                const grouped = {};
                appState.plans.forEach(p => {
                    const d = p.date || 'unscheduled';
                    if (!grouped[d]) grouped[d] = [];
                    grouped[d].push(p);
                });

                const sortedDates = Object.keys(grouped).sort();
                
                sortedDates.forEach(date => {
                    if (date === 'unscheduled') return;
                    
                    const dateObj = new Date(date);
                    const days = ['日', '一', '二', '三', '四', '五', '六'];
                    const dateDisplay = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()} (${days[dateObj.getDay()]})`;
                    
                    const details = document.createElement('details');
                    details.className = 'group bg-muji-card rounded-lg shadow-sm border border-muji-border overflow-hidden mb-4';
                    details.open = true;
                    
                    details.innerHTML = `
                        <summary class="px-4 py-3 bg-muji-bg border-b border-muji-border flex justify-between items-center font-bold text-muji-text">
                            <span><i class="fas fa-calendar-day mr-2 text-muji-accent"></i>${dateDisplay}</span>
                            <i class="fas fa-chevron-down text-muji-sub text-xs transition-transform duration-300"></i>
                        </summary>
                        <div class="p-2 space-y-4" id="group-${date}"></div>
                        <div class="px-2 pb-2 pt-2">
                            <button onclick="window.app.openPlanEditor(null, '${date}')" class="w-full py-2 border-2 border-dashed border-muji-border rounded text-xs text-muji-sub hover:bg-muji-bg hover:text-muji-accent transition">
                                <i class="fas fa-plus mr-1"></i> 新增行程
                            </button>
                        </div>
                    `;
                    container.appendChild(details);
                    
                    const groupContainer = details.querySelector(`#group-${date}`);
                    grouped[date].forEach((p, idx) => {
                        renderPlanItem(groupContainer, p, idx, grouped[date].length);
                    });
                });

                if (grouped['unscheduled'] && grouped['unscheduled'].length > 0) {
                    const details = document.createElement('details');
                    details.className = 'group bg-muji-card rounded-lg shadow-sm border border-muji-border overflow-hidden mb-4';
                    details.open = true;
                    details.innerHTML = `
                        <summary class="px-4 py-3 bg-gray-100 border-b border-muji-border flex justify-between items-center font-bold text-gray-500">
                            <span><i class="fas fa-question-circle mr-2"></i>未排定日期</span>
                            <i class="fas fa-chevron-down text-xs transition-transform duration-300"></i>
                        </summary>
                        <div class="p-2 space-y-4" id="group-unscheduled"></div>
                    `;
                    container.appendChild(details);
                    const groupContainer = details.querySelector(`#group-unscheduled`);
                    grouped['unscheduled'].forEach((p, idx) => {
                        renderPlanItem(groupContainer, p, idx, grouped['unscheduled'].length);
                    });
                }

                if(appState.planView === 'calendar') window.app.renderCalendar();
            });
        }

        function renderPlanItem(container, plan, index, total) {
            const dotColor = index === 0 ? 'bg-muji-accent border-2 border-white' : 'bg-white border-2 border-muji-sub';
            const hl = plan.highlight ? `<p class="text-sm mb-2"><span class="bg-yellow-100 text-yellow-800 px-1 rounded text-xs mr-1">重要</span> ${plan.highlight}</p>` : '';
            const map = plan.mapQuery ? `<div class="mt-3 flex gap-2"><button class="text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200" onclick="window.app.openMap('${plan.mapQuery}')">地圖引導</button></div>` : '';
            
            const isFirst = index === 0;
            const isLast = index === total - 1;
            const upBtn = isFirst ? `<span class="w-6"></span>` : `<button onclick="window.app.movePlan('${plan.id}', -1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-muji-accent"><i class="fas fa-chevron-up text-xs"></i></button>`;
            const downBtn = isLast ? `<span class="w-6"></span>` : `<button onclick="window.app.movePlan('${plan.id}', 1)" class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-muji-accent"><i class="fas fa-chevron-down text-xs"></i></button>`;

            let timeHtml = '';
            if(plan.time) {
                // CHANGED: text-lg, font-bold, text-muji-text (was text-[10px] text-muji-sub)
                timeHtml = `<div class="text-lg font-bold text-muji-text mb-1 font-mono">${plan.time}</div>`;
            }

            const div = document.createElement('div');
            div.className = 'relative group ml-2 pl-4 border-l-2 border-muji-border';
            div.innerHTML = `
                <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full ${dotColor} z-10"></div>
                <div class="flex justify-between items-start pl-2 mb-1">
                    <div class="flex-1">${timeHtml}<h4 class="font-bold text-lg text-muji-text">${plan.title}</h4></div>
                    <div class="flex items-center gap-1">${upBtn}${downBtn}<button onclick="window.app.openPlanEditor('${plan.id}')" class="w-6 h-6 flex items-center justify-center text-gray-300 hover:text-muji-sub ml-2"><i class="fas fa-pen text-xs"></i></button></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-transparent hover:border-muji-border transition">${hl}<p class="text-sm text-muji-sub whitespace-pre-wrap">${plan.content}</p>${map}</div>
            `;
            container.appendChild(div);
        }

        function initHotels() {
            if(!db) return;
            onSnapshot(query(collection(db, "hotels"), orderBy("created", "asc")), (snap) => {
                showSync();
                const planContainer = document.getElementById('hotel-container');
                const guideContainer = document.getElementById('hotel-guide-container');
                
                if(planContainer) planContainer.innerHTML = '';
                if(guideContainer) guideContainer.innerHTML = '';
                
                window.app.hotelsCache = [];
                snap.forEach(d => {
                    const h = {id: d.id, ...d.data()};
                    window.app.hotelsCache.push(h);
                    const ph = h.phone ? `<a href="tel:${h.phone}" class="text-xs text-blue-500 mr-2"><i class="fas fa-phone mr-1"></i>${h.phone}</a>` : '';
                    
                    let dateDisplay = "";
                    if (h.dateStart && h.dateEnd) {
                        const s = new Date(h.dateStart);
                        const e = new Date(h.dateEnd);
                        // CHANGED: dd/mm format, text-sm, text-muji-accent (or text-muji-text, used accent for differentiation)
                        dateDisplay = `<p class="text-sm text-muji-accent mb-1 font-bold">${s.getDate()}/${s.getMonth()+1} - ${e.getDate()}/${e.getMonth()+1}</p>`;
                    } else if (h.dateStart) {
                         const s = new Date(h.dateStart);
                         dateDisplay = `<p class="text-sm text-muji-accent mb-1 font-bold">${s.getDate()}/${s.getMonth()+1} 起</p>`;
                    }

                    // Card HTML (Reusable)
                    const cardHtml = `
                        <div class="flex items-start bg-muji-bg p-3 rounded border border-muji-border relative group mb-3 last:mb-0">
                            <div class="bg-white p-2 rounded mr-3 shadow-sm text-muji-accent"><i class="fas fa-hotel"></i></div>
                            <div class="flex-1">
                                ${dateDisplay}
                                <h4 class="font-bold text-sm leading-tight">${h.name}</h4>
                                <p class="text-xs text-muji-sub mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${h.location}</p>
                                <div class="mt-2 flex flex-wrap gap-y-1 gap-x-3 text-xs text-muji-text"><span class="bg-white px-1 rounded border border-gray-100">${h.checkin}</span><span class="bg-white px-1 rounded border border-gray-100">${h.checkout}</span>${ph}</div>
                                <div class="mt-2"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name)}" target="_blank" class="inline-block text-[10px] bg-muji-kraft px-2 py-1 rounded text-muji-text hover:bg-muji-sub hover:text-white transition">Google Maps</a></div>
                            </div>
                            <button onclick="window.app.openHotelEditor('${h.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-muji-sub p-1"><i class="fas fa-pen text-xs"></i></button>
                        </div>
                    `;

                    // Card HTML for GUIDE (Detailed with notes)
                    const guideCardHtml = `
                        <div class="pb-6 border-b border-gray-100 last:border-0 last:pb-0">
                            <span class="inline-block bg-muji-sub text-white text-[10px] px-2 py-0.5 rounded mb-2">${dateDisplay.replace(/<[^>]*>/g, '') || '住宿'}</span>
                            <h4 class="font-bold text-base mb-1">${h.name} <button onclick="window.app.openHotelEditor('${h.id}')" class="text-gray-300 hover:text-muji-sub ml-1 text-xs"><i class="fas fa-pen"></i></button></h4>
                            <p class="text-xs text-muji-sub mb-3"><i class="fas fa-map-marker-alt mr-1"></i>${h.location}</p>
                            
                            <div class="grid grid-cols-2 gap-2 mb-3 bg-gray-50 p-2 rounded">
                                <div><span class="text-xs text-gray-400 block">Check-in</span><span class="font-bold">${h.checkin}</span></div>
                                <div><span class="text-xs text-gray-400 block">Check-out</span><span class="font-bold">${h.checkout}</span></div>
                            </div>
                            ${ph ? `<p class="text-xs mb-2"><i class="fas fa-phone w-5 text-center text-muji-sub"></i><a href="tel:${h.phone}" class="text-blue-600">${h.phone}</a></p>` : ''}
                            ${h.notes ? `<div class="mt-3 p-3 border border-gray-200 rounded text-xs text-gray-600 bg-white whitespace-pre-wrap">${h.notes}</div>` : ''}
                        </div>
                    `;

                    if(planContainer) planContainer.innerHTML += cardHtml;
                    if(guideContainer) guideContainer.innerHTML += guideCardHtml;
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initPlans();
                initHotels();
                initLists();
                initSettings(); 
                window.app.updateDate();
            }, 100);
        });

    </script>
</body>
</html>

